# –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–∏—Å–æ–∫ —É–ª—É—á—à–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã –°–∏–º—É–ª—è—Ü–∏—è + –ù–∞—Ä—Ä–∞—Ç–∏–≤.

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ

### 1. –Ø–∑—ã–∫ thinking
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ú–æ–¥–µ–ª—å —Ä–∞–∑–º—ã—à–ª—è–ª–∞ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ
- **–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è `–Ø–ó–´–ö: –î—É–º–∞–π –∏ –æ—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ` –≤ –æ–±–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–∞

### 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- **–ü—Ä–æ–±–ª–µ–º–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
- **–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è `required` –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ `geminiService.ts`

---

## –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç üü°

### 3. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ tool calls
**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö (–æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è tool calls).

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –í—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é:

```typescript
const executeToolCalls = (
  calls: FunctionCall[], 
  state: GameState, 
  tools: GameTool[], 
  iteration: number
): { 
  newState: GameState; 
  logs: ToolCallLog[]; 
  responseParts: Part[] 
} => {
  // ... –ª–æ–≥–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
};
```

**–§–∞–π–ª**: `services/geminiService.ts`

---

### 4. –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ª–æ–∫–∞—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–∞—Ä—Ä–∞—Ç–∏–≤–∞
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–∞—Ä—Ä–∞—Ç–∏–≤ –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ `userPrompt` + `toolsSummary`, –Ω–æ –Ω–µ –∑–Ω–∞–µ—Ç, –≤ –∫–∞–∫–æ–π –ª–æ–∫–∞—Ü–∏–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∏–≥—Ä–æ–∫.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ª–æ–∫–∞—Ü–∏–∏ –≤ –Ω–∞—Ä—Ä–∞—Ç–∏–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å:

```typescript
const playerLocation = workingState.locations.find(
  l => l.id === workingState.players[0]?.locationId
);
const locationContext = playerLocation 
  ? `\n\n–¢–µ–∫—É—â–∞—è –ª–æ–∫–∞—Ü–∏—è: ${playerLocation.name}\n${playerLocation.description}\n–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞: ${playerLocation.currentSituation}`
  : '';

// –î–æ–±–∞–≤–∏—Ç—å locationContext –≤ narrativeContents
```

**–§–∞–π–ª**: `services/geminiService.ts`, —Å—Ç—Ä–æ–∫–∏ 455-463

---

### 5. –ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π –≤ –Ω–∞—Ä—Ä–∞—Ç–∏–≤–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–∞—Ä—Ä–∞—Ç–∏–≤ –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π —Ö–æ–¥, –Ω–µ –∑–Ω–∞—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–±—ã—Ç–∏–π. –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∫ –ø–æ—Ç–µ—Ä–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `recentActions` –≤ `GameState`:

```typescript
interface GameState {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
  recentActions?: Array<{
    turn: number;
    playerAction: string;
    result: string;
  }>;
}
```

–ò –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3-5 –¥–µ–π—Å—Ç–≤–∏–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞—Ä—Ä–∞—Ç–∏–≤–∞.

**–§–∞–π–ª—ã**: `types.ts`, `services/geminiService.ts`

---

### 6. –ë–æ–ª—å—à–æ–π JSON —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
**–ü—Ä–æ–±–ª–µ–º–∞**: –í–µ—Å—å `GameState` —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å, —á—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏—Ö –º–∏—Ä–æ–≤.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
- –¢–µ–∫—É—â–∞—è –ª–æ–∫–∞—Ü–∏—è –∏–≥—Ä–æ–∫–∞
- –û–±—ä–µ–∫—Ç—ã –≤ —Ç–µ–∫—É—â–µ–π –ª–æ–∫–∞—Ü–∏–∏
- –ò–≥—Ä–æ–∫ –∏ –µ–≥–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
- –°–æ—Å–µ–¥–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏ (–±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è)

```typescript
const getRelevantState = (state: GameState, playerId: string) => {
  const player = state.players.find(p => p.id === playerId);
  const location = state.locations.find(l => l.id === player?.locationId);
  const localObjects = state.objects.filter(o => 
    o.connectionId === player?.id || o.connectionId === location?.id
  );
  // ... —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
};
```

**–§–∞–π–ª**: `services/geminiService.ts`

---

## –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç üü¢

### 7. –ù–µ—Ç retry –ª–æ–≥–∏–∫–∏
**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ API –≤–µ—Ä–Ω—ë—Ç –æ—à–∏–±–∫—É (429 Too Many Requests, 503 Service Unavailable), –Ω–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –î–æ–±–∞–≤–∏—Ç—å retry —Å exponential backoff:

```typescript
const withRetry = async <T>(
  fn: () => Promise<T>, 
  maxRetries = 3, 
  baseDelay = 1000
): Promise<T> => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (e: any) {
      if (i === maxRetries - 1) throw e;
      if (e.status === 429 || e.status === 503) {
        await sleep(baseDelay * Math.pow(2, i));
      } else {
        throw e;
      }
    }
  }
  throw new Error('Max retries exceeded');
};
```

**–§–∞–π–ª**: `services/geminiService.ts` –∏–ª–∏ –Ω–æ–≤—ã–π `utils/retry.ts`

---

### 8. –ù–µ—Ç —Ç–∞–π–º–∞—É—Ç–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ API –∑–∞–≤–∏—Å, –∑–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç –≤–∏—Å–µ—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –î–æ–±–∞–≤–∏—Ç—å AbortController —Å —Ç–∞–π–º–∞—É—Ç–æ–º:

```typescript
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 30000);

try {
  const response = await ai.models.generateContent({
    // ... –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    signal: controller.signal
  });
} finally {
  clearTimeout(timeoutId);
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–∏ Google GenAI SDK —Å–∏–≥–Ω–∞–ª—ã abort.

**–§–∞–π–ª**: `services/geminiService.ts`

---

### 9. –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
**–ü—Ä–æ–±–ª–µ–º–∞**: `createSystemInstruction` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ú–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```typescript
const instructionCache = new Map<string, string>();

const createSystemInstruction = (state: GameState, isFinalNarrative: boolean) => {
  const cacheKey = `${JSON.stringify(state)}-${isFinalNarrative}`;
  if (instructionCache.has(cacheKey)) {
    return instructionCache.get(cacheKey)!;
  }
  // ... —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
  instructionCache.set(cacheKey, result);
  return result;
};
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –ö—ç—à –¥–æ–ª–∂–µ–Ω –æ—á–∏—â–∞—Ç—å—Å—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏.

**–§–∞–π–ª**: `services/geminiService.ts`

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è üèóÔ∏è

### 10. –í—ã–Ω–µ—Å—Ç–∏ –ø—Ä–æ–º–ø—Ç—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª
–°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ –∏ –Ω–∞—Ä—Ä–∞—Ç–∏–≤–∞ –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ `prompts/systemPrompts.ts` –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

### 11. –¢–∏–ø–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ API
–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–≥—É—é —Ç–∏–ø–∏–∑–∞—Ü–∏—é –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ Gemini API –≤–º–µ—Å—Ç–æ `any`.

### 12. Unit-—Ç–µ—Å—Ç—ã –¥–ª—è geminiService
–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã —Å –º–æ–∫–∞–º–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ tool calls –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞—Ä—Ä–∞—Ç–∏–≤–∞.

---

## –ö–∞–∫ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. –î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
2. –£–∫–∞–∂–∏—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å –ø—Ä–∏–º–µ—Ä–æ–º –∫–æ–¥–∞
3. –£–∫–∞–∂–∏—Ç–µ —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å
4. –ü—Ä–∏—Å–≤–æ–π—Ç–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (üî¥ –≤—ã—Å–æ–∫–∏–π, üü° —Å—Ä–µ–¥–Ω–∏–π, üü¢ –Ω–∏–∑–∫–∏–π)
5. –ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –≤ —Å–µ–∫—Ü–∏—é "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ"






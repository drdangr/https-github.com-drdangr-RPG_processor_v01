# Модель Данных (Game State)

Состояние игры хранится в едином объекте `GameState`. Ниже описаны основные сущности.

## Полная структура GameState

```typescript
interface GameState {
  world: WorldData;
  locations: LocationData[];
  players: PlayerData[];
  objects: ObjectData[];
}
```

## 1. World (Мир)

Общие настройки сеттинга.

```typescript
interface WorldData {
  worldDescription: string; // Литературное описание атмосферы
  gameGenre: string;        // Жанр (влияет на стиль ответов ИИ)
}
```

## 2. Locations (Локации)

Места, где могут находиться персонажи и предметы.

```typescript
interface LocationData {
  id: string;               // Уникальный ID (напр. "loc_001")
  name: string;             // Название
  description: string;      // Статичное описание
  currentSituation: string; // Динамическое описание (погода, события)
  connections: Array<{      // Связи (граф переходов между локациями)
    targetLocationId: string;
    type: 'in' | 'out' | 'bidirectional';
  }>;
  attributes: Record<string, string>; // Нарративные характеристики
}
```

**Типы связей:**

* `bidirectional` — можно перемещаться в обе стороны
* `in` — можно только войти (из целевой локации в текущую)
* `out` — можно только выйти (из текущей локации в целевую)

## 3. Players (Игроки/Персонажи)

Активные действующие лица.

```typescript
interface PlayerData {
  id: string;          // Уникальный ID (напр. "char_001")
  name: string;        // Имя персонажа
  description: string; // Описание внешности, характера
  locationId: string;  // ID локации, где находится персонаж
  attributes: Record<string, string>; // Нарративные характеристики
}
```

## 4. Objects (Предметы)

Все интерактивные объекты в мире.

```typescript
interface ObjectData {
  id: string;           // Уникальный ID (напр. "obj_001")
  name: string;         // Название
  connectionId: string; // ID родителя (владельца/контейнера)
  attributes: Record<string, string>; // Нарративные характеристики
}
```

### connectionId — ключевое поле

Определяет, где находится объект:

| connectionId указывает на | Значение |
|---------------------------|----------|
| ID Локации | Объект лежит в этой локации |
| ID Игрока | Объект принадлежит этому игроку (в инвентаре) |
| ID Другого объекта | Объект находится внутри контейнера |

**Пример иерархии:**

```
loc_saloon (локация)
├── obj_table (стол) — connectionId: "loc_saloon"
│   └── obj_bottle (бутылка) — connectionId: "obj_table"
└── char_jack (игрок) — locationId: "loc_saloon"
    └── obj_gun (пистолет) — connectionId: "char_jack"
```

## Система нарративных атрибутов

Все сущности используют универсальную систему `attributes` для хранения характеристик в виде **текстовых описаний вместо цифр**.

### Принципы

* **Нарративность**: Все характеристики — текстовые описания
  * ✅ `"умирает от жажды"`
  * ❌ `"health: 10%"`
* **Гибкость**: Любые названия атрибутов
* **Динамичность**: Атрибуты можно создавать, изменять и удалять в процессе игры

### Примеры атрибутов

**Игрок:**

```typescript
attributes: {
  health: "уставший и голодный, но способен действовать",
  condition: "ранен в плечо, но рана не критична",
  magic: "владеет базовыми заклинаниями защиты",
  aura: "вокруг него мерцает слабая магическая аура"
}
```

**Объект:**

```typescript
attributes: {
  condition: "полная",
  content: "качественный ром",
  material: "стекло",
  appearance: "тёмное стекло, старая этикетка",
  type: "алкогольный напиток"
}
```

**Локация:**

```typescript
attributes: {
  state: "беспорядок после недавней драки",
  safety: "относительно безопасно",
  atmosphere: "напряженная, чувствуется опасность"
}
```

### Инструменты для работы с атрибутами

| Инструмент | Описание |
|------------|----------|
| `set_attribute` | Создание/изменение атрибута |
| `delete_attribute` | Удаление атрибута |

## Соглашения по именованию ID

| Тип сущности | Префикс | Пример |
|--------------|---------|--------|
| Локация | `loc_` | `loc_saloon`, `loc_street` |
| Игрок/Персонаж | `char_` | `char_jack`, `char_sheriff` |
| Объект | `obj_` | `obj_gun`, `obj_key` |

При создании объектов через `create_object` ID генерируется автоматически:

```
obj_{timestamp}_{random}
// Пример: obj_1764727509035_scu0
```

## Принципы связей

### Location Awareness (Видимость объектов)

ИИ определяет, что видит игрок, анализируя связи:

1. **Объекты в локации игрока:**

   ```
   object.connectionId === player.locationId
   ```

2. **Объекты у игрока:**

   ```
   object.connectionId === player.id
   ```

3. **Объекты внутри видимых контейнеров:**
   Рекурсивная проверка `connectionId` до локации или игрока.

### Перемещение объектов

Перемещение предмета = изменение его `connectionId`:

```typescript
// Игрок берёт ключ со стола
obj_key.connectionId = "char_jack"  // было: "obj_table"
```

### Перемещение персонажей

Перемещение персонажа = изменение его `locationId`.
Используется инструмент `move_player` для безопасного перемещения с проверкой графа локаций:

```typescript
// Джек переходит в салун
char_jack.locationId = "loc_saloon"
```

### Защита от ошибок

Инструмент `move_object` проверяет:

* Существование объекта и цели
* Нельзя переместить объект в самого себя
* Нельзя создать циклическую зависимость (A содержит B, B содержит A)

# Архитектура и Поток Данных

## Общая концепция
Приложение работает по циклу **"Запрос -> Обработка ИИ -> Локальное выполнение -> Нарратив"**. Приложение является "толстым клиентом", вся логика изменения состояния (кроме генерации текста) выполняется в браузере.

## Жизненный цикл хода (Game Turn)

Логика сосредоточена в файле `services/geminiService.ts`, функция `processGameTurn`.

1.  **Сбор данных:**
    *   Берется текущий `GameState` (Мир, Локации, Игроки, Объекты).
    *   Берется текстовый ввод пользователя (`userPrompt`).
    *   Собирается список активных инструментов (`enabledTools`).

2.  **Первый запрос к Gemini (Decision Making):**
    *   Отправляется промпт и определения инструментов (`toolDefinitions`).
    *   Системная инструкция требует от ИИ проанализировать ситуацию и вызвать функции, если нужно изменить состояние.

3.  **Локальное выполнение инструментов:**
    *   Если ИИ присылает `functionCall`, приложение **не** отправляет это обратно на сервер сразу.
    *   Оно ищет соответствующий TS-файл инструмента в `tools/`.
    *   Выполняет функцию `apply(state, args)` локально.
    *   Это создает `newState` (виртуальное состояние) и текстовый результат выполнения (например, "Объект перемещен").

4.  **Второй запрос к Gemini (Narrative Generation):**
    *   В историю чата добавляется результат выполнения инструментов.
    *   Отправляется запрос на генерацию финального текста (повествования), описывающего, что произошло, основываясь на результатах инструментов.

5.  **Обновление UI:**
    *   Пользователю показывается `narrative` (текст).
    *   Пользователю показывается `toolLogs` (технические логи).
    *   Пользователю предлагается принять изменения (`DiffView`), которые обновят React State.

## Структура Проекта

*   `src/data/` - Статические исходные данные (Mock data) для инициализации.
*   `src/types.ts` - TypeScript интерфейсы всей системы.
*   `src/tools/` - Каталог инструментов (см. `TOOLS_SYSTEM.md`).
*   `src/components/FormEditors.tsx` - UI компоненты для редактирования сущностей. Вместо сырого JSON используются формы с валидацией и защитой от расширений браузера.
*   `src/services/geminiService.ts` - Взаимодействие с API и оркестрация вызовов.
*   `src/utils/gameUtils.ts` - Вспомогательные функции (клонирование состояния и т.д.).

## Обработка Ошибок
*   **API Errors:** Если ключа нет или API недоступен, ошибка выводится в UI.
*   **Tool Errors:** Если ИИ вызвал инструмент с неверными аргументами, `apply` вернет строку с ошибкой. Эта строка отправляется обратно ИИ, чтобы он мог (в теории) извиниться или обыграть неудачу в тексте.
*   **Extension Interference:** Поля ввода защищены атрибутами (random ID, `autocomplete="off"`), чтобы расширения браузера не ломали React-компоненты.
